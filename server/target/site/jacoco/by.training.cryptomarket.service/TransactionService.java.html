<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">by.training.cryptomarket.service</a> &gt; <span class="el_source">TransactionService.java</span></div><h1>TransactionService.java</h1><pre class="source lang-java linenums">package by.training.cryptomarket.service;



import by.training.cryptomarket.dao.sql.CoinDaoImpl;
import by.training.cryptomarket.dao.sql.TransactionDaoImpl;
import by.training.cryptomarket.dao.sql.UserDaoImpl;
import by.training.cryptomarket.dao.transaction.ApproveRequestTransaction;
import by.training.cryptomarket.dao.transaction.RejectRequestTransaction;
import by.training.cryptomarket.dao.transaction.WithdrawTransaction;
import by.training.cryptomarket.entity.Coin;
import by.training.cryptomarket.entity.Transaction;
import by.training.cryptomarket.entity.mapping.MappingTransaction;
import by.training.cryptomarket.enums.TransactionStatus;
import by.training.cryptomarket.enums.TransactionType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;


/**
 * This service ensures interact with transactions.
 *
 * @author Nikita Karchahin
 * @version 1.0
 */
@Component
<span class="fc" id="L31">public class TransactionService {</span>

    @Autowired
    WithdrawTransaction withdrawTransaction;

    @Autowired
    RejectRequestTransaction rejectRequestTransaction;

    @Autowired
    ApproveRequestTransaction approveRequestTransaction;

    @Autowired
    UserDaoImpl userDao;

    @Autowired
    TransactionDaoImpl transactionDao;

    @Autowired
    CoinDaoImpl coinDao;


    /**
     * Method for getting collection of transactions.
     * @return all transactions
     * @throws Exception Exception
     */
    public List&lt;MappingTransaction&gt; getAllTransactions() throws Exception {


        List&lt;Transaction&gt; transactions;
<span class="fc" id="L61">        List&lt;MappingTransaction&gt; mappingTransactions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L62">        transactions = transactionDao.read();</span>


<span class="fc bfc" id="L65" title="All 2 branches covered.">                   for (Transaction transaction : transactions) {</span>
<span class="fc" id="L66">                       MappingTransaction mappingTransaction = new MappingTransaction();</span>
<span class="fc" id="L67">                       mappingTransaction.setIdentity(transaction.getIdentity());</span>
<span class="fc" id="L68">                       mappingTransaction.setAmount(transaction.getAmount());</span>
<span class="fc" id="L69">                       mappingTransaction.setType(transaction.getType().toString());</span>
<span class="fc" id="L70">                       mappingTransaction.setStatus(transaction.getStatus().toString());</span>
<span class="fc" id="L71">                       mappingTransaction.setCoin(coinDao.read(transaction.getCoinId()).getFullName());</span>
<span class="fc" id="L72">                       mappingTransaction.setUser(userDao.read(transaction.getUserId()).getUserName());</span>
<span class="fc" id="L73">                       mappingTransactions.add(mappingTransaction);</span>
<span class="fc" id="L74">                   }</span>




<span class="fc" id="L79">        return  mappingTransactions;</span>
    }



    /**
     * Method for getting collection of transactions.
     * @param userName userName
     * @return transactions by userName
     * @throws Exception Exception
     */
    public List&lt;MappingTransaction&gt; getTransactionsByUser(final String userName) throws Exception {

<span class="fc" id="L92">        List&lt;MappingTransaction&gt; mappingTransactions = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        for (MappingTransaction mappingTransaction : getAllTransactions()) {</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">           if (mappingTransaction.getUser().equals(userName)) {</span>
<span class="nc" id="L95">               mappingTransactions.add(mappingTransaction);</span>
           }
<span class="fc" id="L97">        }</span>
<span class="fc" id="L98">        return  mappingTransactions;</span>
    }


    /**
     *  Method for getting collection of transactions.
     * @return pending transactions
     * @throws Exception Exception
     */
    public List&lt;MappingTransaction&gt; getPendingTransactions() throws Exception {
<span class="nc" id="L108">        List&lt;MappingTransaction&gt; mappingTransactions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        for (MappingTransaction mappingTransaction : getAllTransactions()) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (mappingTransaction.getStatus().equals(&quot;pending&quot;)) {</span>
<span class="nc" id="L111">                mappingTransactions.add(mappingTransaction);</span>
            }
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">        return  mappingTransactions;</span>
    }


    /**
     * Method which approves transaction.
     * @param identity identity
     * @throws Exception Exception
     */
    public void approveTransaction(final Integer identity) throws Exception {

<span class="nc" id="L125">            approveRequestTransaction.setIdTransaction(identity);</span>
<span class="nc" id="L126">            approveRequestTransaction.commit();</span>
<span class="nc" id="L127">    }</span>

    /**
     * Method which rejects transaction.
     * @param identity identity
     * @throws Exception Exception
     */
    public void rejectTransaction(final Integer identity) throws Exception {
<span class="nc" id="L135">            rejectRequestTransaction.setIdTransaction(identity);</span>
<span class="nc" id="L136">            rejectRequestTransaction.commit();</span>

<span class="nc" id="L138">    }</span>


    /**
     *  The method for creating a deposit transaction.
     * @param userId userId
     * @param amount amount
     * @param coin coin
     * @throws Exception Exception
     */
    public void setDepositTransaction(final Integer userId,
                                      final Double amount,
                                      final String coin) throws  Exception {

<span class="fc" id="L152">            List&lt;Coin&gt; coins = coinDao.read();</span>
<span class="fc" id="L153">                 Integer coinId = null;</span>



<span class="fc bfc" id="L157" title="All 2 branches covered.">            for (Coin coin1 : coins) {</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">               if (coin1.getTicker().equals(coin)) {</span>
<span class="fc" id="L159">                   coinId = coin1.getIdentity();</span>
               }
<span class="fc" id="L161">            }</span>



<span class="fc" id="L165">        Transaction transaction = new Transaction();</span>
<span class="fc" id="L166">            transaction.setCoinId(coinId);</span>
<span class="fc" id="L167">            transaction.setStatus(TransactionStatus.pending);</span>
<span class="fc" id="L168">            transaction.setType(TransactionType.deposit);</span>
<span class="fc" id="L169">            transaction.setUserId(userId);</span>
<span class="fc" id="L170">            transaction.setAmount(amount);</span>

<span class="fc" id="L172">            transactionDao.create(transaction);</span>


<span class="fc" id="L175">    }</span>


    /**
     *  The method for creating a withdraw transaction.
     * @param userId userId
     * @param amount amount
     * @param coin coin
     * @throws Exception Exception
     */
    public void setWithdrawTransaction(final Integer userId,
                                       final Double amount,
                                       final String coin) throws Exception {
<span class="fc" id="L188">       Connection connection = null;</span>



<span class="fc" id="L192">            List&lt;Coin&gt; coins = coinDao.read();</span>
<span class="fc" id="L193">            Integer coinId = null;</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">            for (Coin coin1 : coins) {</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">                if (coin1.getTicker().equals(coin)) {</span>
<span class="fc" id="L196">                    coinId = coin1.getIdentity();</span>
                }
<span class="fc" id="L198">            }</span>
<span class="fc" id="L199">            Transaction transaction = new Transaction();</span>
<span class="fc" id="L200">            transaction.setCoinId(coinId);</span>
<span class="fc" id="L201">            transaction.setStatus(TransactionStatus.pending);</span>
<span class="fc" id="L202">            transaction.setType(TransactionType.withdraw);</span>
<span class="fc" id="L203">            transaction.setUserId(userId);</span>
<span class="fc" id="L204">            transaction.setAmount(amount);</span>
<span class="fc" id="L205">            withdrawTransaction.setTransaction(transaction);</span>
<span class="fc" id="L206">            withdrawTransaction.commit();</span>


<span class="fc" id="L209">    }</span>




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>